<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emotion Music Recommendation</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Bigelow+Rules&display=swap"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='style.css') }}"
      rel="stylesheet"
    />
    <style>
      .recording-controls {
        margin: 20px;
        text-align: center;
      }
      .recording-controls button {
        background-color: #16213e;
        border-radius: 5px;
        color: aliceblue;
        font-weight: 900;
        margin: 10px;
      }
      .recording-controls #start,
      .recording-controls #stop,
      .recording-controls #play,
      .recording-controls #detect {
        margin: 10px;
      }
      #audioPlayback {
        margin-top: 20px;
      }
      #emotionResult {
        color: #16213e;
        font-weight: bold;
      }
      .feedback-section .rating span {
        font-size: 2em;
        cursor: pointer;
      }
      .feedback-section .rating span:hover,
      .feedback-section .rating span:hover ~ span {
        color: gold;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <a href="#" class="logo"><h3>eMuse</h3></a>
      <nav class="navbar">
        <a class="under" href="#home">Home</a>
        <a class="under" href="#aboutproject">Project</a>
        <a class="under" href="#aboutus">About</a>
        <a class="under" href="#services">Services</a>
        <a class="under" href="#contactus">Feedback</a>
      </nav>
    </header>

    <section class="home" id="home">
      <div class="slider">
        <div class="home-content">
          <h3 class="home-welcome">Welcome To</h3>
          <h1 class="home-welcomes">eMuse</h1>
        </div>
      </div>
    </section>

    <section class="about-emuse" id="aboutproject">
      <div class="overlay">
        <div class="about-content">
          <h2 class="heading">About <span>eMuse</span></h2>
          <p>
            Feel the Music, We Hear Your Emotions By analyzing these emotional
            cues, these systems curate playlists that perfectly match our moods,
            enhancing our listening experience. This personalized approach helps
            users discover new favorites and tailor their soundtracks to life's
            various moments. eMuse, for instance, leverages this technology to
            ensure that every song resonates with how you feel, making music a
            more intimate and responsive companion.
          </p>
        </div>
      </div>
    </section>

    <section class="about-us" id="aboutus">
      <h1>About Us</h1>
      <div class="wrap">
        <div class="cards-container">
          <div
            class="card"
            style="
              width: 18rem;
              background-color: white;
              border-radius: 8px;
              padding: 20px;
            "
          >
            <div>
              <div class="card-heading">
                <h3 class="heading-hover">Swetha</h3>
              </div>
              <div class="card-context">
                <p>
                  I am Swetha currently pursuing Btech 3rd year in AI&DS branch
                  at VNRVJIET. In this project I have worked on Web Development
                  and Documentation.
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="cards-container">
          <div
            class="card"
            style="
              width: 18rem;
              background-color: white;
              border-radius: 8px;
              padding: 20px;
            "
          >
            <div>
              <div class="card-heading">
                <h3 class="heading-hover">Hemasree Vemulamada</h3>
              </div>
              <div class="card-context">
                <p>
                  I am Hemasree currently pursuing Btech 3rd year in AI&DS
                  branch at VNRVJIET. I have worked on Machine Learning Model
                  and Web Development.
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="cards-container">
          <div
            class="card"
            style="
              width: 18rem;
              background-color: white;
              border-radius: 8px;
              padding: 20px;
            "
          >
            <div>
              <div class="card-heading">
                <h3 class="heading-hover">Roshini Reddy</h3>
              </div>
              <div class="card-context">
                <p>
                  I am Roshini Reddy currently pursuing Btech 3rd year in AI&DS
                  branch at VNRVJIET. I have worked on Web Development and
                  Spotify Connection to the Model.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="services" class="section">
      <p class="section-header">Services</p>
      <div class="container">
        <div class="left">
          <h2
            style="
              font-family: 'sans-serif';
              font-size: 30px;
              text-align: center;
            "
          >
            Emotion Detector
          </h2>
          <div class="video-container">
            <img
              class="outer-shadow"
              id="bg"
              src="{{ url_for('video_feed') }}"
              class="center img-fluid"
            />
          </div>
        </div>
        <div class="right">
          <h2
            style="
              font-family: 'sans-serif';
              font-size: 30px;
              text-align: center;
            "
          >
            Song Recommendations
          </h2>
          <div class="recommendation-table-container">
            <div class="outer-shadow" id="ResultArea"></div>
          </div>
        </div>
      </div>
      <div class="btncontainer">
        <button class="refresh" id="refreshButton">Refresh</button>
        <button class="button" id="stopButton">Detect</button>
      </div>
    </section>

    <h1 style="color: #16213e; margin-left: 10px; font-weight: 900px">
      Voice Detector
    </h1>
    <section class="recording-controls">
      <button id="start">Start Recording</button>
      <button id="stop">Stop Recording</button>
      <button id="play">Play Recorded Audio</button>
      <button id="detect">Detect Emotion</button>
      <audio id="audioPlayback" controls></audio>
      <p id="emotionResult"></p>
    </section>

    <section class="ContactUs" id="contactus">
      <div class="feedback-section">
        <h2 style="color: #16213e; font-weight: bolder; text-align: center">
          GIVE US YOUR FEEDBACK
        </h2>
        <p style="color: black; text-align: center">
          We value your opinion. Please share your feedback with us!
        </p>
        <div class="feedback-container">
          <form id="feedbackForm">
            <div class="input-group">
              <input
                type="text"
                name="name"
                id="name"
                class="input-field"
                placeholder="Your Name"
                required
              />
              <input
                type="email"
                name="email"
                id="email"
                class="input-field"
                placeholder="Your Email"
                required
              />
            </div>
            <textarea
              id="feedback"
              name="feedback"
              class="input-field feedback-textarea"
              placeholder="Your Feedback"
              required
            ></textarea>
            <p>Rate your experience:</p>
            <div class="rating">
              <span data-value="5">★</span>
              <span data-value="4">★</span>
              <span data-value="3">★</span>
              <span data-value="2">★</span>
              <span data-value="1">★</span>
            </div>
            <button type="submit" class="send">SUBMIT FEEDBACK</button>
          </form>
        </div>
      </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      let recordedBlob;
      let mediaRecorder;
      let audioChunks = [];

      let stopButtonClicked = false;

      // Function to handle detect button click
      $(".button").on("click", function () {
        stopEmotionDetection();
      });

      // Function to handle refresh button click
      $(".refresh").on("click", function () {
        refreshPage();
      });

      // Function to stop emotion detection
      function stopEmotionDetection() {
        $.ajax({
          type: "GET",
          url: "/stop_emotion_detection",
          success: function (response) {
            stopButtonClicked = true;
            console.log("Emotion detection stopped successfully.");
            updateVideoFeed();
          },
          error: function (error) {
            console.log("Error stopping emotion detection:", error);
          },
        });
      }

      // Function to start emotion detection
      function startEmotionDetection() {
        $.ajax({
          type: "GET",
          url: "/start_emotion_detection",
          success: function (response) {
            stopButtonClicked = false;
            console.log("Emotion detection started successfully.");
            updateVideoFeed(); // Ensure the video feed updates and shows the emotion tag
          },
          error: function (error) {
            console.log("Error starting emotion detection:", error);
          },
        });
      }

      // Function to periodically update the table
      setInterval(function () {
        if (!stopButtonClicked) {
          $.getJSON("/t", function (data) {
            createHtmlTable(data);
          });
        }
      }, 1000);

      // Function to create HTML table from data
      function createHtmlTable(data) {
        $("#ResultArea").html("");
        var table = $(
          "<table class='table table-striped table-light table-bordered table-hover table-sm table-responsive' id='DynamicTable'></table>"
        ).appendTo("#ResultArea");
        var rowHeader = $("<tr></tr>").appendTo(table);
        $("<td></td>").text("Name").appendTo(rowHeader);
        $("<td></td>").text("Album").appendTo(rowHeader);
        $("<td></td>").text("Artist").appendTo(rowHeader);
        $("<td></td>").text("Spotify Link").appendTo(rowHeader);
        $.each(data, function (i, value) {
          var row = $("<tr></tr>").appendTo(table);
          $("<td></td>").text(value.Name).appendTo(row);
          $("<td></td>").text(value.Album).appendTo(row);
          $("<td></td>").text(value.Artist).appendTo(row);
          $("<td></td>")
            .html(
              '<a href="' +
                value["Spotify Link"] +
                '" target="_blank">' +
                value["Spotify Link"] +
                "</a>"
            )
            .appendTo(row);
        });
      }

      // Function to refresh the page
      function refreshPage() {
        setTimeout(function () {
          $("#ResultArea").html(""); // Clear results
          startEmotionDetection();
        }, 200);
      }

      // Function to update video feed
      function updateVideoFeed() {
        $("#bg").attr("src", "/video_feed?" + new Date().getTime()); // Ensure the video feed updates
      }

      // Start recording
      document.getElementById("start").addEventListener("click", () => {
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };
            mediaRecorder.onstop = () => {
              recordedBlob = new Blob(audioChunks, { type: "audio/wav" });
              document.getElementById("audioPlayback").src =
                URL.createObjectURL(recordedBlob);
              audioChunks = [];
            };
            mediaRecorder.start();
          })
          .catch((error) => {
            console.error("Error accessing audio stream:", error);
          });
      });

      // Stop recording
      document.getElementById("stop").addEventListener("click", () => {
        if (mediaRecorder) {
          mediaRecorder.stop();
        }
      });

      // Play recorded audio
      document.getElementById("play").addEventListener("click", () => {
        if (recordedBlob) {
          const audio = document.getElementById("audioPlayback");
          audio.src = URL.createObjectURL(recordedBlob);
          audio.play();
        }
      });
      document.getElementById("detect").addEventListener("click", () => {
        if (recordedBlob) {
          const formData = new FormData();
          formData.append("audio", recordedBlob, "recorded_audio.wav");

          fetch("/detect_emotion", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              const emotion = data.emotion || "calm";
              document.getElementById(
                "emotionResult"
              ).textContent = `Detected Emotion: ${emotion}`;
            })
            .catch((error) => {
              console.error("Error detecting emotion:", error);
              document.getElementById("emotionResult").textContent =
                "Error detecting emotion.";
            });
        } else {
          alert("No audio recorded!");
        }
      });
    </script>
  </body>
</html>
